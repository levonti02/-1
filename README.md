Код говно, но работает. И слава Богу. 
